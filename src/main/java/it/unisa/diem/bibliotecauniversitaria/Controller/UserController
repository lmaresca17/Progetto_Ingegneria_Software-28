package it.unisa.diem.bibliotecauniversitaria.controller;

import it.unisa.diem.bibliotecauniversitaria.model.Utente;
import java.io.IOException;
import java.util.List;
import java.util.Optional;
import javafx.beans.value.ChangeListener;
import javafx.beans.value.ObservableValue;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.control.Alert;
import javafx.scene.control.Alert.AlertType;
import javafx.scene.control.Button;
import javafx.scene.control.ButtonType;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.control.TextInputDialog;
import javafx.scene.control.cell.PropertyValueFactory;

public class UserController {

    // --- Riferimenti FXML (elementi definiti nel file .fxml) ---
    @FXML
    private TableView<Utente> tableViewUtenti;
    @FXML
    private TableColumn<Utente, String> colMatricola;
    @FXML
    private TableColumn<Utente, String> colCognome;
    @FXML
    private TableColumn<Utente, String> colNome;
    @FXML
    private TableColumn<Utente, String> colEmail;
    @FXML
    private TextField txtRicerca;
    @FXML
    private Button btnRicerca;
    @FXML
    private Button btnInserisciUtente;
    @FXML
    private Button btnModificaUtente;
    @FXML
    private Button btnEliminaUtente;
    @FXML
    private Button btnHome;
    
   
    private GestioneUtente gestioneUtente;
    
    
    private ObservableList<Utente> observableListaUtenti;


    @FXML
    public void initialize() {
        gestioneUtente = new GestioneUtente();
        

        gestioneUtente.inserisciUtente(new Utente("M001", "Rossi", "Mario", "mario.rossi@unisa.it"));
        gestioneUtente.inserisciUtente(new Utente("M002", "Bianchi", "Anna", "anna.bianchi@unisa.it"));
        gestioneUtente.inserisciUtente(new Utente("M003", "Verdi", "Luigi", "luigi.verdi@unisa.it"));
        

        colMatricola.setCellValueFactory(new PropertyValueFactory<>("matricola"));
        colCognome.setCellValueFactory(new PropertyValueFactory<>("cognome"));
        colNome.setCellValueFactory(new PropertyValueFactory<>("nome"));
        colEmail.setCellValueFactory(new PropertyValueFactory<>("email"));


        caricaDatiTableView();
        

        tableViewUtenti.getSelectionModel().selectedItemProperty().addListener(new ChangeListener<Utente>() {
            @Override
            public void changed(ObservableValue<? extends Utente> observable, Utente oldValue, Utente newValue) {
                boolean isSelected = newValue != null;
                btnModificaUtente.setDisable(!isSelected);
                btnEliminaUtente.setDisable(!isSelected);
            }
        });
    }
    

    private void caricaDatiTableView() {
        observableListaUtenti = gestioneUtente.getUtentiObservable(); 
        tableViewUtenti.setItems(observableListaUtenti);
    }
    

    @FXML
    private void handleRicerca() {
        String testoRicerca = txtRicerca.getText().trim();
        
        if (testoRicerca.isEmpty()) {
            caricaDatiTableView();
            return;
        }


        List<Utente> risultati = gestioneUtente.cercaPerCognome(testoRicerca);
        

        if (risultati.isEmpty()) {
            Utente utenteMatricola = gestioneUtente.cercaPerMatricola(testoRicerca);
            if (utenteMatricola != null) {
                 risultati.add(utenteMatricola);
            }
        }
        

        observableListaUtenti.setAll(risultati);
        
        if (risultati.isEmpty()) {
             mostraAlert(AlertType.INFORMATION, "Ricerca", "Nessun utente trovato con il criterio specificato.");
        }
    }


    @FXML
    private void handleInserisciUtente() {

        TextInputDialog dialog = new TextInputDialog();
        dialog.setTitle("Nuovo Utente");
        dialog.setHeaderText("Inserimento Nuovo Utente");
        dialog.setContentText("Inserisci Dati (Matricola,Cognome,Nome,Email) separati da virgola:");

        Optional<String> result = dialog.showAndWait();
        if (result.isPresent()) {
            String[] dati = result.get().split(",");
            if (dati.length == 4) {
                try {
                    String matricola = dati[0].trim();
                    String cognome = dati[1].trim();
                    String nome = dati[2].trim();
                    String email = dati[3].trim();

                    Utente nuovoUtente = new Utente(matricola, cognome, nome, email);

                    if (gestioneUtente.inserisciUtente(nuovoUtente)) {
                        mostraAlert(AlertType.INFORMATION, "Successo", "Utente inserito con successo.");
                        observableListaUtenti.add(nuovoUtente); // Aggiornamento diretto della lista
                    } else {
                        mostraAlert(AlertType.ERROR, "Errore", "Impossibile inserire l'utente. Matricola già esistente o dati non validi.");
                    }
                } catch (Exception e) {
                    mostraAlert(AlertType.ERROR, "Errore", "Formato dati non corretto.");
                }
            } else {
                mostraAlert(AlertType.ERROR, "Errore", "Devi inserire esattamente 4 campi separati da virgola.");
            }
        }
    }


   @FXML
    private void handleModificaUtente() {
        Utente utenteSelezionato = tableViewUtenti.getSelectionModel().getSelectedItem();
        
        if (utenteSelezionato != null) {
            final String vecchiaMatricola = utenteSelezionato.getMatricola();
            
            
            String defaultInput = String.join(",", vecchiaMatricola, utenteSelezionato.getCognome(), utenteSelezionato.getNome(), utenteSelezionato.getEmail());
            
            TextInputDialog dialog = new TextInputDialog(defaultInput);
            dialog.setTitle("Modifica Utente");
            dialog.setHeaderText("Modifica Dati per " + utenteSelezionato.getCognome() + " " + utenteSelezionato.getNome());
            dialog.setContentText("Aggiorna Dati (Matricola,Cognome,Nome,Email) separati da virgola:");

            Optional<String> result = dialog.showAndWait();
            
            if (result.isPresent()) {
                String[] dati = result.get().split(",");
                if (dati.length == 4) {
                    try {
                        String nuovaMatricola = dati[0].trim();
                        String nuovoCognome = dati[1].trim();
                        String nuovoNome = dati[2].trim();
                        String nuovaEmail = dati[3].trim();
                        
                        
                        Utente utenteAggiornato = new Utente(nuovaMatricola, nuovoCognome, nuovoNome, nuovaEmail);

                        boolean successo = false;
                        
                        if (nuovaMatricola.equals(vecchiaMatricola)) {
                            
                            successo = gestioneUtente.modificaUtente(vecchiaMatricola, utenteAggiornato);
                            
                            if (successo) {
                               
                                utenteSelezionato.setCognome(nuovoCognome);
                                utenteSelezionato.setNome(nuovoNome);
                                utenteSelezionato.setEmail(nuovaEmail);
                                tableViewUtenti.refresh(); 
                            }

                        } else {
                            
                            
                            if (gestioneUtente.cercaPerMatricola(nuovaMatricola) != null) {
                                mostraAlert(AlertType.ERROR, "Errore", "Impossibile modificare. La nuova matricola (" + nuovaMatricola + ") esiste già.");
                                return;
                            }
                            
                            
                            if (gestioneUtente.cancellaUtente(vecchiaMatricola)) {
                                if (gestioneUtente.inserisciUtente(utenteAggiornato)) {
                                    
                                    observableListaUtenti.remove(utenteSelezionato);
                                    observableListaUtenti.add(utenteAggiornato);
                                    successo = true;
                                } else {
                                    
                                    successo = false;
                                }
                            } else {
                               
                                successo = false;
                            }
                        }
                        
                        if (successo) {
                            mostraAlert(AlertType.INFORMATION, "Successo", "Utente modificato con successo.");
                            
                            caricaDatiTableView(); 
                        } else {
                            mostraAlert(AlertType.ERROR, "Errore", "Modifica fallita. Verifica i dati di input.");
                        }
                        
                    } catch (Exception e) {
                        mostraAlert(AlertType.ERROR, "Errore", "Formato dati non corretto. Dettagli: " + e.getMessage());
                    }
                } else {
                    mostraAlert(AlertType.ERROR, "Errore", "Devi inserire esattamente 4 campi separati da virgola.");
                }
            }
        }
    }


    @FXML
    private void handleEliminaUtente() {
        Utente utenteSelezionato = tableViewUtenti.getSelectionModel().getSelectedItem();
        
        if (utenteSelezionato != null) {
            Alert confirmAlert = new Alert(AlertType.CONFIRMATION);
            confirmAlert.setTitle("Conferma Eliminazione");
            confirmAlert.setHeaderText("Eliminazione Utente");
            confirmAlert.setContentText("Sei sicuro di voler eliminare l'utente: " + utenteSelezionato.getCognome() + " " + utenteSelezionato.getNome() + "?");
            
            Optional<ButtonType> result = confirmAlert.showAndWait();
            
            if (result.isPresent() && result.get() == ButtonType.OK) {

                boolean successo = gestioneUtente.cancellaUtente(utenteSelezionato.getMatricola());
                
                if (successo) {
                    observableListaUtenti.remove(utenteSelezionato);
                    mostraAlert(AlertType.INFORMATION, "Eliminazione", "Utente eliminato con successo.");
                } else {
                    mostraAlert(AlertType.ERROR, "Errore", "Impossibile eliminare l'utente dal sistema.");
                }
            }
        }
    }
    
 
    @FXML
    private void handleHome() {
        mostraAlert(AlertType.INFORMATION, "Navigazione", "Torno alla schermata Home.");
    }
    

    private void mostraAlert(AlertType type, String title, String message) {
        Alert alert = new Alert(type);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }
}
